{% extends "admin/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="grid grid-cols-1 gap-4 mb-8 sm:grid-cols-2 lg:grid-cols-4">
    <div class="overflow-hidden bg-white rounded-lg shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-blue-500 rounded-md">
                    <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                </div>
                <div class="flex-1 w-0 ml-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            Total Productos
                        </dt>
                        <dd class="text-lg font-semibold text-gray-900">
                            {{ total_productos }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="px-5 py-3 bg-gray-50">
            <div class="text-sm">
                <a href="{{ url_for('admin.admin_productos') }}"
                    class="font-medium text-blue-700 hover:text-blue-900">Ver
                    todos</a>
            </div>
        </div>
    </div>

    <div class="overflow-hidden bg-white rounded-lg shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-green-500 rounded-md">
                    <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <div class="flex-1 w-0 ml-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            Pedidos Pendientes
                        </dt>
                        <dd class="text-lg font-semibold text-gray-900">
                            {{ pedidos_pendientes }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="px-5 py-3 bg-gray-50">
            <div class="text-sm">
                <a href="{{ url_for('admin.admin_pedidos') }}"
                    class="font-medium text-green-700 hover:text-green-900">Ver
                    todos</a>
            </div>
        </div>
    </div>

    <div class="overflow-hidden bg-white rounded-lg shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-yellow-500 rounded-md">
                    <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                </div>
                <div class="flex-1 w-0 ml-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            Total Usuarios
                        </dt>
                        <dd class="text-lg font-semibold text-gray-900">
                            {{ total_usuarios }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="px-5 py-3 bg-gray-50">
            <div class="text-sm">
                <a href="{{ url_for('admin.admin_usuarios') }}"
                    class="font-medium text-yellow-700 hover:text-yellow-900">Ver
                    todos</a>
            </div>
        </div>
    </div>

    <div class="overflow-hidden bg-white rounded-lg shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-red-500 rounded-md">
                    <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                </div>
                <div class="flex-1 w-0 ml-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            Ingresos del Mes
                        </dt>
                        <dd class="text-lg font-semibold text-gray-900">
                            S/.{{ ingresos_mes }}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="px-5 py-3 bg-gray-50">
            <div class="text-sm">
                <a href="#" class="font-medium text-red-700 hover:text-red-900">Ver detalles</a>
            </div>
        </div>
    </div>
</div>

<div id="notificaciones-container" class="mb-8">
    <h2 class="text-xl font-semibold">Notificaciones</h2>
    <ul id="notificaciones-list" class="mt-4">
        {% for notificacion in notificaciones %}
        <li id="notificacion-{{ notificacion.id }}" class="px-4 py-2 border-b notification-item">
            <div class="flex items-center justify-between">
                <span>{{ notificacion.mensaje }}</span>
                <button onclick="marcarComoVisto('{{ notificacion.id }}', this.parentElement.parentElement)"
                    class="px-2 py-1 text-white bg-blue-500 rounded hover:bg-blue-600">
                    Marcar como vista
                </button>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>


{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Obtener el token CSRF una sola vez al cargar
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Función para formatear la fecha
        function formatearFecha(fechaStr) {
            const fecha = new Date(fechaStr);
            return fecha.toLocaleString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para obtener las notificaciones no vistas
        function obtenerNotificaciones() {
            fetch("{{ url_for('admin.obtener_notificaciones') }}", {
                headers: {
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    const notificacionesList = document.getElementById('notificaciones-list');
                    notificacionesList.innerHTML = ''; // Limpiar la lista

                    if (data.length === 0) {
                        const emptyMessage = document.createElement('li');
                        emptyMessage.className = 'p-4 text-center text-gray-500';
                        emptyMessage.textContent = 'No hay notificaciones nuevas';
                        notificacionesList.appendChild(emptyMessage);
                        return;
                    }

                    data.forEach(notificacion => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-4 bg-white rounded shadow mb-2 hover:bg-gray-50 transition-colors duration-200';
                        li.id = `notificacion-${notificacion.id}`;

                        const contenido = document.createElement('div');
                        contenido.className = 'flex-grow';
                        contenido.innerHTML = `
                        <div class="flex items-center">
                            <img src="/static/img/${notificacion.usuario_foto || 'default-user.jpg'}"
                                alt="Usuario" 
                                class="object-cover w-8 h-8 mr-4 rounded-full">
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-gray-900">${notificacion.usuario_nombre}</p>
                                <p class="text-sm text-gray-600">${notificacion.mensaje}</p>
                                <p class="text-xs text-gray-400">${formatearFecha(notificacion.fecha_creacion)}</p>
                            </div>
                        </div>
                    `;
                        const boton = document.createElement('button');
                        boton.className = 'ml-4 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors duration-200 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
                        boton.innerText = 'Marcar como visto';

                        // Prevenir múltiples clics
                        boton.addEventListener('click', function (e) {
                            e.preventDefault();
                            if (!this.disabled) {
                                this.disabled = true;
                                marcarComoVisto(notificacion.id, li);
                            }
                        });

                        li.appendChild(contenido);
                        li.appendChild(boton);
                        notificacionesList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error al obtener notificaciones:', error);
                    const notificacionesList = document.getElementById('notificaciones-list');
                    notificacionesList.innerHTML = `
                    <li class="p-4 text-center text-red-500">
                        Error al cargar las notificaciones. Por favor, intente nuevamente.
                    </li>
                `;
                });
        }

        // Función para marcar una notificación como vista
        function marcarComoVisto(notificacionId, elemento) {
            const formData = new FormData();
            formData.append('notificacion_id', notificacionId);

            fetch("{{ url_for('admin.marcar_notificacion_vista') }}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData,
                credentials: 'same-origin'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        elemento.classList.add('fade-out');
                        setTimeout(() => {
                            elemento.remove();
                            // Verificar si no hay más notificaciones
                            const notificacionesList = document.getElementById('notificaciones-list');
                            if (notificacionesList.children.length === 0) {
                                const emptyMessage = document.createElement('li');
                                emptyMessage.className = 'p-4 text-center text-gray-500';
                                emptyMessage.textContent = 'No hay notificaciones nuevas';
                                notificacionesList.appendChild(emptyMessage);
                            }
                        }, 300);
                    } else {
                        throw new Error(data.error || 'No se pudo marcar la notificación como vista');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al marcar la notificación como vista: ' + error.message);
                    // Reactivar el botón en caso de error
                    const boton = elemento.querySelector('button');
                    if (boton) boton.disabled = false;
                });
        }

        // Iniciar el sistema de notificaciones
        obtenerNotificaciones();
        const intervaloActualizacion = setInterval(obtenerNotificaciones, 5000);

        // Limpiar el intervalo cuando el usuario cambie de página
        window.addEventListener('beforeunload', () => {
            clearInterval(intervaloActualizacion);
        });
    });
</script>
{% endblock %}